[% set title = "Contest " + cid %]
[% set page_url = contest_url + 'contest/' + cid %]

<!DOCTYPE html>
<html lang="ja" ng-app="contestApp">
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  [% import "components/header.html" as header %]
  [[ header.print(title=title, description=contest_description, sitename=contest_name, contest_url=contest_url, page_url=page_url) ]]

  <link rel="stylesheet" media="screen" href="/assets/stylesheets/modal.css">

  [% import "components/basejs.html" as basejs %]
  [[ basejs.print(firebaseapp_contest, firebaseapp_contest_apikey, firebaseapp_contest_senderid, firebaseapp_wca) ]]
</head>
<body>
  <div class="container">
    [% import "components/bodyheader.html" as bodyheader %]
    [[ bodyheader.print(title=title, contest_name=contest_name) ]]

    <div ng-controller="AuthCtrl">
      <div ng-hide="authLoaded">auth loaded</div>
    </div>
    <div ng-controller="ContestIndexCtrl">
      <div ng-hide="contestIndexLoaded">contest index loaded</div>
    </div>
    <div ng-controller="ContestCtrl">
      <div ng-hide="contestLoaded">contest loaded</div>
    </div>

    [% include "components/bodyfooter.html" %]

    [% import "components/authjs.html" as authjs %]
    [[ authjs.print(redirect_login="", redirect_logout="", check_first=True) ]]

    [% import "components/contestjs.html" as contestjs %]
    [[ contestjs.print(cid=cid, fetch_scrambles=False, fetch_results_top3=True, fetch_results_all=False)]]

    <script>
      app.controller("ContestIndexCtrl", [
        "$scope",
        "$timeout",
        function ($scope, $timeout) {
          firebase.auth().onAuthStateChanged(function (authData) {
            $scope.eventsDone = {};
            $scope.justSuspended = null;
            $scope.justDone = null;
            $scope.justDoneText = "";
            $scope.justDoneEvent = "";

            $scope.contestIndexLoaded = true;

            $scope.currentContest = "[[ cid ]]";
            $scope.contestsList = null;

            // Read personal results
            if (authData) {
              contestRef
                .child("contests")
                .child("c[[ cid ]]")
                .once("value", function (snapContest) {
                  if (snapContest.exists()) {
                    var contestData = snapContest.val();
                    contestData.events.forEach(function (e) {
                      contestRef
                        .child("results")
                        .child("c[[ cid ]]")
                        .child(e)
                        .child(authData.uid)
                        .once(
                          "value",
                          function (snapResult) {
                            var resultData = snapResult.val();
                            $timeout(function () {
                              if (!resultData) {
                                $scope.eventsDone[e] = false;
                              } else {
                                if (resultData.endAt) {
                                  $scope.eventsDone[e] = true;
                                } else {
                                  $scope.eventsDone[e] = resultData.type;
                                }
                              }
                            });
                          },
                          function (error) {
                            console.error(error);
                          }
                        );
                    });
                  } else {
                    console.error("Undefined contest: [[ cid ]]");
                  }
                });

              var vars = getUrlVars();
              if (vars.suspended) {
                var qe = "e" + vars.suspended;
                contestRef.child("events").once(
                  "value",
                  function (snapEvents) {
                    if (snapEvents.exists() && snapEvents.val()[qe]) {
                      $timeout(function () {
                        $scope.justSuspended = snapEvents.val()[qe].name;
                        // うまくDOMのサイズが取得できないときがあるので何回か呼ぶ
                        showModalSuspended();
                        for (var delay = 1; delay <= 20; delay++) {
                          $timeout(showModalSuspended, delay * 50);
                        }
                        for (var delay = 2; delay <= 10; delay++) {
                          $timeout(showModalSuspended, delay * 1000);
                        }
                      });
                    }
                  },
                  function (error) {
                    console.error(error);
                  }
                );

                // Modal
                var modalOverlayElem =
                  document.getElementById("modal-overlay");
                var modalSuspendedElem =
                  document.getElementById("modal-suspended");
                var modalSuspendedCloseElem = document.getElementById(
                  "modal-suspended-close"
                );
                var modalOverlayNgElem = angular.element(modalOverlayElem);
                var modalSuspendedNgElem =
                  angular.element(modalSuspendedElem);
                modalOverlayNgElem.removeClass("hide");
                modalSuspendedNgElem.removeClass("hide");
                var showModalSuspended = function () {
                  var windowW = window.innerWidth;
                  var windowH = window.innerHeight;
                  var modalW = modalSuspendedElem.offsetWidth;
                  var modalH = modalSuspendedElem.offsetHeight;
                  modalSuspendedNgElem.css(
                    "left",
                    (windowW - modalW) / 2 + "px"
                  );
                  modalSuspendedNgElem.css(
                    "top",
                    (windowH - modalH) / 2 + "px"
                  );
                };
                var closeModalSuspended = function () {
                  modalOverlayNgElem.addClass("hide");
                  modalSuspendedNgElem.addClass("hide");
                  history.replaceState("", "", "[[ cid ]]");
                };
                modalOverlayElem.onclick = closeModalSuspended;
                modalSuspendedCloseElem.onclick = closeModalSuspended;
              } else if (vars.done) {
                var qe = "e" + vars.done;
                $scope.justDoneEvent = vars.done;
                contestRef
                  .child("contests")
                  .child("c[[ cid ]]")
                  .once("value", function (snapContest) {
                    var contest = snapContest.val();
                    var season = "";
                    if (contest.season == 1) {
                      season = "前半期";
                    } else if (contest.season == 2) {
                      season = "後半期";
                    }
                    contestRef.child("events").once(
                      "value",
                      function (snapEvents) {
                        if (snapEvents.exists() && snapEvents.val()[qe]) {
                          $timeout(function () {
                            $scope.justDone = snapEvents.val()[qe].name;
                            $scope.justDoneText =
                              snapEvents.val()[qe].name +
                              " に参加しました！%0a" +
                              contest.contestName +
                              "%0a" +
                              "締め切りは毎週日曜21時です。";
                            // うまくDOMのサイズが取得できないときがあるので何回か呼ぶ
                            showModalDone();
                            for (var delay = 1; delay <= 20; delay++) {
                              $timeout(showModalDone, delay * 50);
                            }
                            for (var delay = 2; delay <= 10; delay++) {
                              $timeout(showModalDone, delay * 1000);
                            }
                          });
                        }
                      },
                      function (error) {
                        console.error(error);
                      }
                    );
                  });

                // Modal
                var modalOverlayElem =
                  document.getElementById("modal-overlay");
                var modalDoneElem = document.getElementById("modal-done");
                var modalDoneCloseElem =
                  document.getElementById("modal-done-close");
                var modalOverlayNgElem = angular.element(modalOverlayElem);
                var modalDoneNgElem = angular.element(modalDoneElem);
                modalOverlayNgElem.removeClass("hide");
                modalDoneNgElem.removeClass("hide");
                var showModalDone = function () {
                  var windowW = window.innerWidth;
                  var windowH = window.innerHeight;
                  var modalW = modalDoneElem.offsetWidth;
                  var modalH = modalDoneElem.offsetHeight;
                  modalDoneNgElem.css("left", (windowW - modalW) / 2 + "px");
                  modalDoneNgElem.css("top", (windowH - modalH) / 2 + "px");
                };
                var closeModalDone = function () {
                  modalOverlayNgElem.addClass("hide");
                  modalDoneNgElem.addClass("hide");
                  history.replaceState("", "", "[[ cid ]]");
                };
                modalOverlayElem.onclick = closeModalDone;
                modalDoneCloseElem.onclick = closeModalDone;
              }
            }

            // 今シーズンの開催済みコンテストリスト
            // とりあえず contests テーブルから引っ張ってくる
            contestRef
              .child("contests")
              .once("value", function (snapContests) {
                var contests = snapContests.val();
                contestRef
                  .child("inProgress")
                  .once("value", function (snapInProgress) {
                    var lastContest = snapInProgress.val().lastContest;
                    var _contestsList = [];
                    Object.keys(snapContests.val()).forEach(function (
                      contestId
                    ) {
                      if (contestId <= lastContest) {
                        _contestsList.push({
                          id: contestId,
                          name: contests[contestId].contestName,
                          shortName:
                            contests[contestId].contestName.slice(15),
                        });
                      }
                    });
                    $timeout(function () {
                      $scope.contestsList = _contestsList;
                    });
                  });
              });

            $scope.currentContestChange = function () {
              location.href = "/contest/" + $scope.currentContest;
            };

            var showDetailList = [];
            $scope.showDetail = function (eid, index) {
              var id = "" + eid + index;
              if (eid == "e333fm") {
                if (!showDetailList[id]) {
                  showDetailList[id] = true;
                  var html =
                    '<tr id="row-detail-' +
                    id +
                    '" class="row-detail"><td colspan="7">' +
                    "<p><b>解答:</b><br>" +
                    TriboxContest.escapeHTML(
                      $scope.resultsTop3["e333fm"][index].details[0].solution
                    ) +
                    "</p>" +
                    "<p><b>解説コメント:</b><br>" +
                    TriboxContest.escapeHTML(
                      $scope.resultsTop3["e333fm"][index].details[0].note
                    ) +
                    "</p>";
                  angular
                    .element(document.getElementById("e333fm-" + index))
                    .after(html);
                  //angular.element(document.getElementById('e333fm-' + index + '-show')).text('表示済み');
                  fadeIn(document.getElementById("row-detail-" + id));
                } else {
                  showDetailList[id] = false;
                  angular
                    .element(document.getElementById("row-detail-" + id))
                    .remove();
                }
              } else {
                if (!showDetailList[id]) {
                  showDetailList[id] = true;
                  var html =
                    '<tr id="row-detail-' +
                    id +
                    '" class="row-detail"><td colspan="7">' +
                    TriboxContest.escapeHTML(
                      $scope.resultsTop3[eid][index].detailsF
                    );
                  angular
                    .element(document.getElementById(eid + "-" + index))
                    .after(html);
                  fadeIn(document.getElementById("row-detail-" + id));
                } else {
                  showDetailList[id] = false;
                  angular
                    .element(document.getElementById("row-detail-" + id))
                    .remove();
                }
              }
            };
          }); // onAuthStateChange

          $scope.publishContest = function (contest, url) {
            var ok = confirm(
              "【確認】コンテスト (" +
                contest +
                ") の結果ページを公開しますか？"
            );
            if (ok) {
              window.open(url, "_blank");
            }
          };
          $scope.unpublishContest = function (contest, url) {
            var ok = confirm(
              "【確認】コンテスト (" +
                contest +
                ") の結果ページを非公開にしますか？"
            );
            if (ok) {
              window.open(url, "_blank");
            }
          };
          $scope.tweetContest = function (contest, url) {
            var ok = confirm(
              "【確認】コンテスト (" +
                contest +
                ") の優勝者をツイートしますか？"
            );
            if (ok) {
              window.open(url, "_blank");
            }
          };
        },
      ]);
    </script>
  </div>
</body>
</html>
